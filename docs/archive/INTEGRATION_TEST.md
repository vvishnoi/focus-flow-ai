# FocusFlow AI - Integration Testing Guide

## ‚úÖ Frontend-Backend Integration

The frontend is now fully connected to the backend API and AI analysis pipeline.

## üîÑ Complete Data Flow

```
1. User plays game ‚Üí Session data collected
2. Session ends ‚Üí Data sent to API Gateway
3. Lambda stores data in S3
4. S3 event triggers analysis
5. Bedrock Agent analyzes with Claude
6. Report stored in DynamoDB
7. Dashboard fetches and displays report
```

## üß™ Testing the Integration

### Step 1: Play a Game Session

1. Open your CloudFront URL in browser
2. Select any game level (Level 1 recommended for testing)
3. Allow camera access
4. Complete calibration
5. Play for at least 30 seconds
6. Click "End Session"

**Expected Result:**
- Session summary appears
- Console shows: "Submitting session to backend..."
- Console shows: "Session submitted successfully"
- Console shows: "AI analysis will be available in ~30 seconds"

### Step 2: Verify Backend Processing

Check CloudWatch logs:

```bash
# Data Ingestor logs
aws logs tail /aws/lambda/focusflow-data-ingestor-dev --follow

# Should show:
# - Session data received
# - S3 key created
# - DynamoDB user record updated
```

### Step 3: Verify S3 Storage

```bash
# Get bucket name
BUCKET=$(cd infra/terraform && terraform output -raw s3_bucket_name)

# List sessions
aws s3 ls s3://$BUCKET/sessions/ --recursive

# Should show: sessions/user_xxx/session_xxx_timestamp.json
```

### Step 4: Verify AI Analysis

Wait 30 seconds, then check:

```bash
# Analysis Trigger logs
aws logs tail /aws/lambda/focusflow-analysis-trigger-dev --follow

# Should show:
# - S3 event received
# - Bedrock Agent invoked
# - Report stored in DynamoDB
```

### Step 5: View Report in Dashboard

1. Click "View Progress Dashboard" on home page
2. Wait for reports to load

**Expected Result:**
- Dashboard shows your session report
- Report includes:
  - Session summary
  - Performance highlights
  - Key metrics
  - Recommendations
  - Generated by "claude-sonnet-4.5"

### Step 6: Verify API Directly

```bash
# Get API URL
API_URL=$(cd infra/terraform && terraform output -raw api_gateway_url)

# Get your user ID from browser console or localStorage
# Then fetch reports
curl $API_URL/reports/user_xxx | jq
```

**Expected Response:**
```json
{
  "userId": "user_xxx",
  "reports": [
    {
      "sessionId": "session_xxx",
      "timestamp": 1234567890,
      "report": "Session Summary\n...",
      "modelUsed": "claude-sonnet-4.5"
    }
  ],
  "count": 1
}
```

## üîç Debugging

### Issue: Session not submitting

**Check:**
1. Browser console for errors
2. API URL is correct (check .env.production)
3. CORS is configured properly
4. API Gateway is deployed

**Solution:**
```bash
# Verify API URL
cd infra/terraform
terraform output api_gateway_url

# Check if it matches frontend/.env.production
cat ../frontend/.env.production
```

### Issue: No reports appearing

**Check:**
1. Wait at least 30 seconds after session
2. Check CloudWatch logs for errors
3. Verify Bedrock Agent is working
4. Check DynamoDB for reports

**Solution:**
```bash
# Check DynamoDB
TABLE=$(cd infra/terraform && terraform output -raw reports_table_name)
aws dynamodb scan --table-name $TABLE --limit 5

# Check Bedrock Agent
AGENT_ID=$(cd infra/terraform && terraform output -raw bedrock_agent_id)
aws bedrock-agent get-agent --agent-id $AGENT_ID
```

### Issue: AI analysis failing

**Check:**
1. Bedrock model access approved
2. IAM permissions correct
3. Lambda timeout sufficient (5 minutes)
4. Metrics calculator working

**Solution:**
```bash
# Test metrics calculator directly
aws lambda invoke \
  --function-name focusflow-metrics-calculator-dev \
  --payload '{"s3Key":"sessions/user_xxx/session_xxx.json","bucketName":"'$BUCKET'"}' \
  response.json

cat response.json
```

## üìä Monitoring

### Real-Time Monitoring

```bash
# Watch all logs
aws logs tail /aws/lambda/focusflow-data-ingestor-dev --follow &
aws logs tail /aws/lambda/focusflow-analysis-trigger-dev --follow &
aws logs tail /aws/lambda/focusflow-metrics-calculator-dev --follow &
```

### Check Metrics

```bash
# Lambda invocations
aws cloudwatch get-metric-statistics \
  --namespace AWS/Lambda \
  --metric-name Invocations \
  --dimensions Name=FunctionName,Value=focusflow-data-ingestor-dev \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Sum

# Bedrock invocations
aws cloudwatch get-metric-statistics \
  --namespace AWS/Bedrock \
  --metric-name Invocations \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Sum
```

## ‚úÖ Success Criteria

- [x] Frontend sends session data to API
- [x] API Gateway receives and routes request
- [x] Lambda stores data in S3
- [x] S3 event triggers analysis
- [x] Bedrock Agent generates report
- [x] Report stored in DynamoDB
- [x] Dashboard fetches and displays report
- [x] User sees AI-generated insights

## üéØ Expected User Experience

1. **Play Game** (2-5 minutes)
   - Smooth gameplay
   - Real-time feedback
   - Tracking accuracy displayed

2. **Session End** (instant)
   - Summary screen appears
   - Data submitted in background
   - Camera turns off

3. **View Dashboard** (30 seconds later)
   - AI report available
   - Warm, encouraging language
   - Actionable recommendations
   - Progress tracking

## üîÑ Redeploy Frontend

If you made changes and need to redeploy:

```bash
./scripts/deploy-frontend.sh
```

This will:
1. Rebuild with latest code
2. Upload to S3
3. Invalidate CloudFront cache
4. New version live in ~5 minutes

## üìù Notes

- **User ID**: Automatically generated and stored in localStorage
- **Session ID**: Generated for each session
- **Reports**: Available ~30 seconds after session ends
- **Persistence**: Reports stored permanently in DynamoDB
- **Privacy**: Each user only sees their own reports

## üéâ You're All Set!

Your frontend is now fully integrated with the backend and AI analysis pipeline. Users can:
- Play therapeutic games
- Get real-time feedback
- Receive AI-generated progress reports
- Track improvement over time

**The complete therapeutic tool is now operational!** üöÄ
